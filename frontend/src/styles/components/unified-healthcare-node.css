/* === UNIFIED HEALTHCARE NODE SYSTEM === */
/* Single source of truth for all node visualizations */
/* Replaces: AgentCard.styles.ts, nodes.css conflicts, mixed styling approaches */

/* === BASE NODE STRUCTURE === */
.unified-healthcare-node {
  /* Dimensions from design tokens - !important prevents React Flow v12 auto-sizing overrides */
  width: var(--gms-node-width-standard) !important;
  min-height: var(--gms-node-min-height) !important;
  max-width: var(--gms-node-width-standard) !important; /* Prevent expansion */
  padding: var(--gms-node-padding);
  
  /* Visual styling */
  background: var(--gms-node-bg-idle);
  border: var(--gms-node-border-width) solid var(--gms-node-border-idle);
  border-radius: var(--gms-node-border-radius);
  box-shadow: var(--gms-node-shadow-base);
  
  /* Transitions */
  transition: var(--gms-node-transition);
  cursor: pointer;
  position: relative; /* CRITICAL: Ensure handles are positioned relative to this container */
  overflow: visible; /* CRITICAL: Allow React Flow handles to show outside node bounds */
  
  /* Performance optimizations - FIXED: Remove layout from contain to fix handle positioning */
  contain: style;
  will-change: transform;
  transform: translateZ(0);
  
  /* Flexbox layout */
  display: flex;
  flex-direction: column;
  gap: 12px;
}

/* === INTERACTIVE STATES === */
.unified-healthcare-node:hover:not(.disabled):not(.dragging) {
  background: var(--gms-node-bg-hover);
  border-color: var(--gms-node-border-hover);
  box-shadow: var(--gms-node-shadow-hover);
  transform: var(--gms-node-transform-hover);
}

.unified-healthcare-node:active:not(.disabled) {
  transform: var(--gms-node-transform-click);
}

.unified-healthcare-node.selected,
.unified-healthcare-node.healthcare-selected {
  background: var(--gms-node-bg-selected);
  border-color: var(--gms-node-border-selected);
  box-shadow: var(--gms-node-shadow-selected);
  transform: translateY(-1px);
  transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Healthcare-specific selection glow for clinical workflows */
.unified-healthcare-node.healthcare-selected::before {
  content: '';
  position: absolute;
  top: -2px;
  left: -2px;
  right: -2px;
  bottom: -2px;
  border-radius: calc(var(--gms-node-border-radius) + 2px);
  background: linear-gradient(135deg, 
    rgba(0, 170, 231, 0.1) 0%, 
    rgba(59, 130, 246, 0.1) 100%);
  z-index: -1;
  pointer-events: none;
}

/* PHI and Compliance badges remain visible during selection */
.unified-healthcare-node.healthcare-selected .node-compliance {
  position: relative;
  z-index: 10;
  background-color: rgba(255, 255, 255, 0.98);
  backdrop-filter: blur(2px);
  border-radius: 6px;
  padding: 4px;
  margin: -2px;
}

/* Ensure selected node content remains readable */
.unified-healthcare-node.healthcare-selected .node-content {
  position: relative;
  z-index: 5;
}

.unified-healthcare-node.dragging {
  opacity: 0.9;
  transform: var(--gms-node-transform-drag);
  box-shadow: var(--gms-node-shadow-dragging);
  z-index: 1000;
  cursor: grabbing;
}

.unified-healthcare-node.disabled {
  opacity: 0.5;
  cursor: not-allowed;
  pointer-events: none;
}

/* === STATUS STATES === */
.unified-healthcare-node.status-running {
  background: var(--gms-node-bg-running);
  border-color: var(--gms-node-border-running);
  animation: healthcare-pulse 2s ease-in-out infinite;
}

.unified-healthcare-node.status-error {
  background: var(--gms-node-bg-error);
  border-color: var(--gms-node-border-error);
  box-shadow: var(--gms-node-shadow-error);
}

.unified-healthcare-node.status-completed {
  background: var(--gms-node-bg-success);
  border-color: var(--gms-node-border-success);
}

/* === PROGRESS BAR === */
.node-progress-bar {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: var(--gms-node-progress-height);
  background: linear-gradient(
    90deg,
    var(--gms-node-progress-color) 0%,
    var(--gms-node-progress-color) var(--progress, 0%),
    var(--gms-node-progress-bg) var(--progress, 0%),
    var(--gms-node-progress-bg) 100%
  );
  border-radius: var(--gms-node-border-radius) var(--gms-node-border-radius) 0 0;
  transition: var(--gms-node-transition-fast);
}

/* === CONTENT LAYOUT === */
.node-content {
  display: flex;
  align-items: flex-start;
  gap: var(--gms-node-content-gap);
  flex: 1;
}

/* === ICON CONTAINER === */
.node-icon-container {
  position: relative;
  flex-shrink: 0;
}

.node-icon {
  width: var(--gms-node-icon-size);
  height: var(--gms-node-icon-size);
  border-radius: var(--gms-node-border-radius);
  background: color-mix(in srgb, var(--icon-color, var(--gms-node-adk-agent-color)) 10%, transparent);
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--icon-color, var(--gms-node-adk-agent-color));
  transition: var(--gms-node-transition-fast);
}

.unified-healthcare-node:hover .node-icon {
  background: color-mix(in srgb, var(--icon-color, var(--gms-node-adk-agent-color)) 15%, transparent);
}

/* === STATUS INDICATOR === */
.node-status-indicator {
  position: absolute;
  bottom: 0;
  right: 0;
  width: 12px;
  height: 12px;
  border-radius: 50%;
  border: 2px solid var(--gms-node-bg-idle);
  transition: var(--gms-node-transition-fast);
}

.node-status-indicator.status-running {
  background: var(--gms-node-border-running);
  animation: pulse 1.5s ease-in-out infinite;
}

.node-status-indicator.status-error {
  background: var(--gms-node-border-error);
}

.node-status-indicator.status-completed {
  background: var(--gms-node-border-success);
}

/* === TEXT CONTENT === */
.node-text {
  flex: 1;
  min-width: 0;
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.node-header {
  display: flex;
  align-items: center;
  gap: 8px;
}

.node-title {
  font-size: var(--gms-node-title-size);
  font-weight: var(--gms-node-title-weight);
  line-height: var(--gms-node-title-line-height);
  color: var(--gms-text-primary, #111827);
  margin: 0;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  flex: 1;
}

.node-version {
  font-size: var(--gms-node-badge-size);
  color: var(--gms-text-secondary, #6b7280);
  background: var(--gms-neutral-100, #f3f4f6);
  padding: 2px 6px;
  border-radius: 4px;
}

.node-description {
  font-size: var(--gms-node-description-size);
  font-weight: var(--gms-node-description-weight);
  line-height: var(--gms-node-description-line-height);
  color: var(--gms-text-secondary, #6b7280);
  margin: 0;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

/* === PERFORMANCE METRICS === */
.node-metrics {
  display: flex;
  gap: 8px;
  margin-top: 4px;
}

.metric {
  display: inline-flex;
  align-items: center;
  gap: 3px;
  font-size: var(--gms-node-metric-size);
  color: var(--gms-text-tertiary, #9ca3af);
  white-space: nowrap;
}

/* === HEALTHCARE COMPLIANCE BADGES === */
.node-compliance {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  margin-top: auto;
}

.badge {
  display: inline-flex;
  align-items: center;
  gap: 2px;
  padding: 2px 6px;
  border-radius: 4px;
  font-size: var(--gms-node-badge-size);
  font-weight: var(--gms-node-badge-weight);
  text-transform: uppercase;
  letter-spacing: var(--gms-node-badge-letter-spacing);
  transition: var(--gms-node-transition-fast);
}

.badge-phi {
  background: var(--gms-phi-bg);
  color: var(--gms-phi-color);
  border: 1px solid var(--gms-phi-border);
}

.badge-audit {
  background: var(--gms-audit-bg);
  color: var(--gms-audit-color);
  border: 1px solid var(--gms-audit-border);
}

.badge-hipaa {
  background: var(--gms-hipaa-bg);
  color: var(--gms-hipaa-color);
  border: 1px solid var(--gms-hipaa-border);
}

.badge-encryption {
  background: var(--gms-neutral-100, #f3f4f6);
  color: var(--gms-text-primary, #111827);
  border: 1px solid var(--gms-neutral-300, #d1d5db);
}

.badge-a2a {
  background: var(--gms-a2a-bg);
  color: var(--gms-a2a-color);
  border: 1px solid var(--gms-a2a-border);
}

.badge-a2a.a2a-healthy {
  border-color: var(--gms-node-border-success);
}

.badge-a2a.a2a-degraded {
  border-color: var(--gms-node-border-warning, #f59e0b);
}

.badge-a2a.a2a-error {
  border-color: var(--gms-node-border-error);
}

.badge-compliance {
  background: var(--gms-neutral-100, #f3f4f6);
  color: var(--gms-text-primary, #111827);
  border: 1px solid var(--gms-neutral-300, #d1d5db);
}

.badge-compliance.compliance-high {
  background: var(--gms-hipaa-bg);
  color: var(--gms-hipaa-color);
  border-color: var(--gms-hipaa-border);
}

.badge-compliance.compliance-medium {
  background: var(--gms-phi-bg);
  color: var(--gms-phi-color);
  border-color: var(--gms-phi-border);
}

.badge-compliance.compliance-low {
  background: var(--gms-node-bg-error);
  color: var(--gms-node-border-error);
  border-color: var(--gms-node-border-error);
}

/* === ERROR MESSAGE === */
.node-error-message {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 6px 8px;
  background: var(--gms-node-bg-error);
  border: 1px solid var(--gms-node-border-error);
  border-radius: 4px;
  color: var(--gms-node-border-error);
  font-size: var(--gms-node-description-size);
  margin-top: 8px;
}

/* === TAGS === */
.node-tags {
  display: flex;
  flex-wrap: wrap;
  gap: 4px;
  margin-top: 8px;
}

.node-tag {
  padding: 2px 8px;
  background: var(--gms-neutral-100, #f3f4f6);
  color: var(--gms-text-secondary, #6b7280);
  border-radius: 12px;
  font-size: var(--gms-node-badge-size);
}

/* === NODE TYPE VARIATIONS === */
.node-type-adk-agent .node-icon {
  --icon-color: var(--gms-node-adk-agent-color);
}

.node-type-static .node-icon {
  --icon-color: var(--gms-node-static-color);
}

.node-type-trigger .node-icon {
  --icon-color: var(--gms-node-trigger-color);
}

.node-type-decision .node-icon {
  --icon-color: var(--gms-node-decision-color);
}

.node-type-tool .node-icon {
  --icon-color: var(--gms-node-tool-color);
}

.node-type-webhook .node-icon {
  --icon-color: var(--gms-node-webhook-color);
}

.node-type-utility .node-icon {
  --icon-color: var(--gms-node-utility-color);
}

/* === ACCESSIBILITY === */
.unified-healthcare-node:focus-visible {
  outline: var(--gms-node-focus-ring-width) solid var(--gms-node-focus-ring);
  outline-offset: var(--gms-node-focus-ring-offset);
}

/* === ANIMATIONS === */
@keyframes healthcare-pulse {
  0%, 100% {
    box-shadow: var(--gms-node-shadow-base);
  }
  50% {
    box-shadow: 
      var(--gms-node-shadow-base),
      0 0 0 4px rgba(0, 170, 231, 0.1);
  }
}

@keyframes pulse {
  0%, 100% {
    opacity: 1;
  }
  50% {
    opacity: 0.5;
  }
}

/* === REACT FLOW HANDLE CUSTOMIZATION === */
.unified-healthcare-node .react-flow__handle {
  width: var(--gms-handle-size);
  height: var(--gms-handle-size);
  background: var(--gms-handle-bg);
  border: var(--gms-handle-border-width) solid var(--gms-handle-border);
  transition: var(--gms-node-transition-fast);
  position: absolute !important; /* CRITICAL: Ensure absolute positioning */
  z-index: 10 !important; /* CRITICAL: Ensure handles appear above node content */
}

/* Handle hover effects - preserve positioning while scaling */
.unified-healthcare-node .react-flow__handle-left:hover,
.unified-healthcare-node .react-flow__handle.react-flow__handle-left:hover {
  transform: translateY(-50%) scale(var(--gms-handle-hover-scale)) !important;
}

.unified-healthcare-node .react-flow__handle-right:hover,
.unified-healthcare-node .react-flow__handle.react-flow__handle-right:hover {
  transform: translateY(-50%) scale(var(--gms-handle-hover-scale)) !important;
}

/* CRITICAL FIX: Strengthen handle positioning with higher specificity */
.unified-healthcare-node .react-flow__handle-left,
.unified-healthcare-node .react-flow__handle.react-flow__handle-left {
  position: absolute !important;
  left: -6px !important;
  top: 50% !important;
  transform: translateY(-50%) !important;
  z-index: 10 !important;
}

.unified-healthcare-node .react-flow__handle-right,
.unified-healthcare-node .react-flow__handle.react-flow__handle-right {
  position: absolute !important;
  left: auto !important; /* Critical: Prevent horizontal centering */
  right: -6px !important;
  top: 50% !important;
  transform: translateY(-50%) !important;
  z-index: 10 !important;
}